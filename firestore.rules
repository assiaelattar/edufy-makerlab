rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user has an elevated role (Admin, Instructor, etc.)
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'instructor', 'admission_officer', 'accountant'];
    }

    // Check if the user is accessing their own document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- 1. CORE IDENTITY & ACCESS (Unified) ---
    
    // STUDENTS: Unified Rule
    // - READ: Allow public 'true' to support Kiosk Login (search by name/keycard without auth)
    // - WRITE: Allow Admin (management) or Owner (self-update)
    match /students/{studentId} {
      allow read: if true; 
      allow write: if isAdmin() || isOwner(studentId);
    }

    match /users/{userId} {
      allow read: if true; // Profile lookups
      allow write: if isAdmin() || isOwner(userId);
    }

    // --- 2. PUBLIC CONTENT & ASSETS (Kiosk/Store Friendly) ---
    
    match /project_templates/{templateId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /process_templates/{workflowId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /stations/{stationId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /badges/{badgeId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /contests/{contestId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /programs/{programId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 3. STUDENT WORK & ENGAGEMENT ---

    // Student Projects: Permissive for Kiosk
    match /student_projects/{projectId} {
      allow read: if true; // Gallery/Showcase access
      allow write: if true; // Kiosk Mode: Students upload anonymously or via simple auth. 
                            // kept as 'true' to prevent "Mission" or "Upload" blockers.
    }

    match /enrollments/{enrollmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 4. ERP & SAAS BUSINESS MODULES ---
    // Critical Data Protection

    // Payments: Users see their own history, Admins see all
    match /payments/{paymentId} {
      allow read: if isSignedIn(); 
      allow write: if isAdmin();
    }

    match /organizations/{orgId} {
      allow read: if true; // Organization lookup for login
      allow write: if isAdmin();
    }
    
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /registrations/{regId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isSignedIn();
    }

    match /attendance/{recordId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /purchase_requests/{reqId} {
      allow read: if isAdmin();
      allow write: if isSignedIn();
    }

    match /inventory/{itemId} {
      allow read: if true; // View available stock
      allow write: if isAdmin();
    }

    match /gadgets/{gadgetId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /gallery_items/{itemId} {
      allow read: if true;
      allow write: if true; // Public access for Emergency Migration
    }

    // --- 5. SYSTEM & LOGGING ---
    match /system_logs/{logId} {
      allow read: if isAdmin();
      allow write: if true; // Client-side error logging
    }

    // --- DEFAULT DENY ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
